From ed824c3406ba2f1cbc15f8722c31d614fbf1f490 Mon Sep 17 00:00:00 2001
From: Jose Alberto Meza <jose.a.meza.arellano@intel.com>
Date: Wed, 30 Dec 2020 14:20:40 -0800
Subject: [PATCH] drivers: peci: xec: Handle corner case for PECI recovery

Handle case where PECI recovery occurs in ISR context.

Signed-off-by: Jose Alberto Meza <jose.a.meza.arellano@intel.com>
---
 drivers/peci/peci_mchp_xec.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/peci/peci_mchp_xec.c b/drivers/peci/peci_mchp_xec.c
index 74683166ea..53a1b3742a 100644
--- a/drivers/peci/peci_mchp_xec.c
+++ b/drivers/peci/peci_mchp_xec.c
@@ -17,6 +17,7 @@ LOG_MODULE_REGISTER(peci_mchp_xec, CONFIG_PECI_LOG_LEVEL);
 #define MAX_PECI_CORE_CLOCK 48000u
 /* 1 ms */
 #define PECI_RESET_DELAY    1000u
+#define PECI_RESET_DELAY_MS 1u
 /* 100 us */
 #define PECI_IDLE_DELAY     100u
 /* 5 ms */
@@ -133,7 +134,13 @@ static void peci_xec_bus_recovery(const struct device *dev, bool full_reset)
 	LOG_WRN("%s full_reset:%d", __func__, full_reset);
 	if (full_reset) {
 		base->CONTROL = MCHP_PECI_CTRL_PD | MCHP_PECI_CTRL_RST;
-		k_busy_wait(PECI_RESET_DELAY);
+
+		if (k_is_in_isr()) {
+			k_msleep(PECI_RESET_DELAY_MS);
+		} else {
+			k_busy_wait(PECI_RESET_DELAY);
+		}
+
 		base->CONTROL &= ~MCHP_PECI_CTRL_RST;
 
 		peci_xec_configure(dev, peci_data.bitrate);
@@ -362,7 +369,7 @@ static int peci_xec_init(const struct device *dev)
 
 	/* Reset PECI interface */
 	base->CONTROL |= MCHP_PECI_CTRL_RST;
-	k_busy_wait(PECI_RESET_DELAY);
+	k_msleep(PECI_RESET_DELAY_MS);
 	base->CONTROL &= ~MCHP_PECI_CTRL_RST;
 
 #ifdef CONFIG_PECI_INTERRUPT_DRIVEN
-- 
2.17.1

